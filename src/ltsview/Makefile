# Relative path to the root of the source tree
TREE_ROOT = ../../

-include $(TREE_ROOT)config

WX_LIBS		:= `$(WX_CONFIG) --libs core base gl`
WX_CXXFLAGS	:= `$(WX_CONFIG) --cxxflags`

ICON_OBJECTS	 = mainframe.o glcanvas.o
WX_OBJECTS	 = ltsviewapp.o mainframe.o glcanvas.o wxthings/spinctld.o markstateruledialog.o
AT_OBJECTS	 = ltsviewapp.o action.o fsmparser.o lts.o state.o
CPP_OBJECTS	 = fileloader.o visualizer.o lts.o state.o transition.o action.o \
		   cluster.o fsmparser.o utils.o glutils.o
ifeq ($(HOST_OS),MACOSX)
GLUT_LDFLAGS     = -framework GLUT -framework OpenGL -lobjc
else
GLUT_LDFLAGS     = -lglut
endif

OBJECTS		 = $(WX_OBJECTS) $(CPP_OBJECTS)
TARGETS		 = ltsview

.PHONY: all clean
.PRECIOUS: fsmparser.cpp fsmlexer.c fsmlexer.h

all : $(TARGETS)

include $(TREE_ROOT)utility/revision.mk

ltsview : $(OBJECTS)
	$(CXX) $(GLUT_LDFLAGS) $(LDFLAGS) $(OBJECTS) $(WX_LIBS) -lATerm -o $@

$(WX_OBJECTS) : %.o: %.cpp
	$(CXX) -c $(WX_CXXFLAGS) $(ATERM_CPPFLAGS) $< -o $@

$(CPP_OBJECTS) : %.o: %.cpp
	$(CXX) -c $< $(ATERM_CPPFLAGS) -o $@

%.cpp : %.h

fsmparser.cpp : fsmparser.y fsmlexer.c
	$(BISON) --defines=fsmlexer.h -o fsmparser.cpp -p fsm $<
	$(CC) -c fsmlexer.c -o fsmlexer.o

fsmlexer.c : fsmlexer.l
	$(LEX) -o$@ -Pfsm $<

$(ICON_OBJECTS) : icons.h icons/*.xpm

$(OBJECTS) $(TARGETS) : Makefile $(CONFIG)

clean:
	-rm -f *.o $(TARGETS) fsmparser.cpp fsmlexer.c fsmlexer.h core core.*

distclean: clean

install: all
	$(INSTALL) -d $(bindir)
	$(INSTALL) ltsview $(bindir)
ifeq ($(HOST_OS),MACOSX)
	/Developer/Tools/Rez -t APPL -o ltsview ../sample.r
	/Developer/Tools/SetFile -a C ltsview
	mkdir -p ../../ltsview.app/Contents
	mkdir -p ../../ltsview.app/Contents/MacOS
	mkdir -p ../../ltsview.app/Contents/Resources
	cp ltsview.plist ../../ltsview.app/Contents/Info.plist
	echo -n "APPL????" > ../../ltsview.app/Contents/PkgInfo
	cp ltsview $(bindir)/ltsview
	ln -f $(bindir)/ltsview ../../ltsview.app/Contents/MacOS/ltsview
	cp -f ltsview.icns ../../ltsview.app/Contents/Resources/ltsview.icns
endif

