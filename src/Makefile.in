#Redefine default definitions using autoconf
CC                 = @CC@
CFLAGS             = @CFLAGS@
CPP                = @CPP@
CPPFLAGS           = @CPPFLAGS@
CXX                = @CXX@
CXXFLAGS           = @CXXFLAGS@
LDFLAGS            = -Wl,-rpath,$(libdir) @LDFLAGS@
ARFLAGS            = crs
INSTALL            = install
LEX                = @LEX@
LFLAGS             = -I -Pgsyy
BISON              = @BISON@
BFLAGS             = -d -pgsyy
USE_XML2           = @USE_XML2@
USE_WX             = @USE_WX@
WX_LIBS            = @WX_LIBS@

#installation directories
prefix             = @prefix@
exec_prefix        = @exec_prefix@
bindir             = @bindir@
libdir             = @libdir@
datadir            = @datadir@
includedir         = @includedir@
infodir            = @infodir@
mandir             = @mandir@

#Parser definitions
LIBPARSER_NAME     = libgsparse.a
LIBPARSER_OBJECTS  = libgsparse.o gsparser.o gslexer.o gstypecheck.o gsdataimpl.o gsfunc.o gslowlevel.o
LIBPARSER_LDFLAGS  = -lATerm -lm
PARSER_NAME        = gsparse
PARSER_OBJECTS     = gsparse.o
PARSER_LDFLAGS     = -lgsparse -lATerm -lm

#Printer definitions
PRINTER_NAME       = gsprint
PRINTER_OBJECTS    = gsprint.o
PRINTER_LDFLAGS    = -lgsparse -lATerm -lm

#Lineariser definitions
LINEARISER_NAME    = linearise
LINEARISER_OBJECTS = linearise.o
LINEARISER_LDFLAGS = -lgsparse -lgsrewrite -lATerm -lm
LIN_NAME           = lin
LIN_OBJECTS        = lin.o gslinearise2.o
LIN_LDFLAGS        = -lgsparse -lATerm -lm

#Rewriter definitions
LIBREWR_NAME       = libgsrewrite.a
LIBREWR_OBJECTS    = libgsrewrite.o gsrewr_inner.o gsrewr_inner2.o gsrewr_inner3.o gsfunc.o gslowlevel.o
LIBREWR_LDFLAGS    = -lATerm -lm
REWR_NAME          = gsrewr
REWR_OBJECTS       = gsrewr.o
REWR_LDFLAGS       = -lgsrewrite -lgsparse -lATerm -lm

#pnml2gs definitions
PNML2GS_NAME       = pnml2gs
PNML2GS_OBJECTS    = pnml2gs.o
PNML2GS_LDFLAGS    = -lgsparse -lATerm -lxml2 -lm

#Instantiator definitions
INSTAN_NAME        = gsinstantiate
INSTAN_OBJECTS     = gsinstantiate.o libgsnextstate.o libgsprover.o
INSTAN_LDFLAGS     = -lgsrewrite -lgsparse -lATerm -lm

#Simulator definitions
SIM_NAME           = sim
SIM_OBJECTS        = sim.o libgsnextstate.o libgsprover.o
SIM_LDFLAGS        = -lgsrewrite -lgsparse -lATerm -lm
XSIM_NAME          = xsim
XSIM_OBJECTS       = xsim.o xsimbase.o xsimmain.o xsimtrace.o libgsnextstate.o libgsprover.o
XSIM_LDFLAGS       = -lgsrewrite -lgsparse -lATerm -lm $(WX_LIBS)

#Group definitions
EXE_NAMES          =  $(PARSER_NAME) $(PRINTER_NAME) $(LINEARISER_NAME) $(LIN_NAME) $(REWR_NAME) $(PNML2GS_NAME) $(INSTAN_NAME) $(SIM_NAME) $(XSIM_NAME)
CUR_EXE_NAMES      ?= $(strip $(foreach s,$(EXE_NAMES),$(shell if test -f $s; then echo -n $s; fi)))
LIB_NAMES          =  $(LIBPARSER_NAME) $(LIBREWR_NAME)
CUR_LIB_NAMES      ?= $(strip $(foreach s,$(LIB_NAMES),$(shell if test -f $s; then echo -n $s; fi)))

#Make rules
.PHONY: all install clean
.PRECIOUS: gsparser.c gslexer.c

all : $(EXE_NAMES)

install : all
ifneq ($(CUR_EXE_NAMES),)
	$(INSTALL) -d $(bindir)
	$(INSTALL) $(CUR_EXE_NAMES) $(bindir)
#	$(INSTALL) -d $(libdir)
#	$(INSTALL) $(CUR_LIB_NAMES) $(libdir)
else
	@echo there aren\'t any executables to be installed
endif

clean :
	$(RM) $(EXE_NAMES) $(LIB_NAMES) *.o *.d gslexer.c gsparser.c gsparser.h\
gsparser.output config.status config.log *~ core core.*

$(LIBPARSER_NAME) : $(LIBPARSER_OBJECTS)
	$(AR) $(ARFLAGS) $@ $(LIBPARSER_OBJECTS)
#	$(CC) -shared -o $@ $(LIBPARSER_OBJECTS)

$(PARSER_NAME) : $(PARSER_OBJECTS) $(LIBPARSER_NAME)
	$(CC) -o $@ $(PARSER_OBJECTS) $(LDFLAGS) $(PARSER_LDFLAGS)

$(PRINTER_NAME) : $(PRINTER_OBJECTS) $(LIBPARSER_NAME)
	$(CC) -o $@ $(PRINTER_OBJECTS) $(LDFLAGS) $(PRINTER_LDFLAGS)

$(LINEARISER_NAME) : $(LINEARISER_OBJECTS) $(LIBPARSER_NAME) $(LIBREWR_NAME)
	$(CC) -o $@ $(LINEARISER_OBJECTS) $(LDFLAGS) $(LINEARISER_LDFLAGS)

$(LIN_NAME) : $(LIN_OBJECTS) $(LIBPARSER_NAME)
	$(CC) -o $@ $(LIN_OBJECTS) $(LDFLAGS) $(LIN_LDFLAGS)

$(LIBREWR_NAME) : $(LIBREWR_OBJECTS)
	$(AR) $(ARFLAGS) $@ $(LIBREWR_OBJECTS)
#	$(CC) -shared -o $@ $(LIBREWR_OBJECTS)

$(REWR_NAME) : $(REWR_OBJECTS) $(LIBPARSER_NAME) $(LIBREWR_NAME)
	$(CC) -o $@ $(REWR_OBJECTS) $(LDFLAGS) $(REWR_LDFLAGS)

ifdef USE_XML2
$(PNML2GS_NAME) : $(PNML2GS_OBJECTS) $(LIBPARSER_NAME)
	$(CC) -o $@ $(PNML2GS_OBJECTS) $(LDFLAGS) $(PNML2GS_LDFLAGS)
else
$(PNML2GS_NAME) :
	@echo cannot make target $@ because the xml2 library cannot be used
endif

$(INSTAN_NAME) : $(INSTAN_OBJECTS) $(LIBPARSER_NAME) $(LIBREWR_NAME)
	$(CC) -o $@ $(INSTAN_OBJECTS) $(LDFLAGS) $(INSTAN_LDFLAGS)

$(SIM_NAME) : $(SIM_OBJECTS) $(LIBPARSER_NAME) $(LIBREWR_NAME)
	$(CC) -o $@ $(SIM_OBJECTS) $(LDFLAGS) $(SIM_LDFLAGS)

ifdef USE_WX
$(XSIM_NAME): $(XSIM_OBJECTS) $(LIBPARSER_NAME) $(LIBREWR_NAME)
	$(CXX) -o $@ $(XSIM_OBJECTS) $(LDFLAGS) $(XSIM_LDFLAGS)
else
$(XSIM_NAME):
	@echo cannot make target $@ because the wxWidgets library cannot be used
endif

%.c : %.y
	$(BISON) $(BFLAGS) -o $@ $<

%.c : %.l
	$(LEX) $(LFLAGS) -o$@ $<

*.* : Makefile

%.d : %.c
	@echo generating dependencies for $<
	@$(CC) -MM $(CPPFLAGS) $< > $@.$$$$; \
	sed 's,\($*\)\.o[ :]*,\1.o $@ : ,g' < $@.$$$$ > $@; \
	$(RM) $@.$$$$

-include $(patsubst %.c,%.d,$(wildcard *.c))


#Note: to make a shared version of the gsparse library instead of a static one, do the following:
#- add the option `-fpic' to CFLAGS
#- change the `a' suffix to `so' in LIBPARSER_NAME
#- in the rule with target $(LIBPARSER_NAME), replace the command by
#    $(CC) -shared -o $@ $(LIBPARSER_OBJECTS) $(LIBPARSER_LDFLAGS)
#- extend the environment variable LD_LIBRARY_PATH with `.'

