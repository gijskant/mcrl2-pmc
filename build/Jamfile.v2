# Author: Jeroen van der Wulp
#
#  Copyright (C) 2008 Eindhoven University of Technology.
#
# Distributed under the Boost Software License, Version 1.0.
# (See accompanying file LICENSE_1_0.txt or copy at
# http://www.boost.org/LICENSE_1_0.txt)
#

project site-config ;

import os ;
import pch ;
import feature ;
import property ;

include $(TOP)/build/config.jam ;

WX_CONFIG ?= shared ;

# Helper rule for extracting compiler/linker options from strings (unix oriented)
local rule requirements-from-string ( arguments * ) {
  for local argument in $(arguments) {
    if [ MATCH ^[-/]D(.*) : $(argument) ] {
      local value = [ MATCH ^[-/]D(.*) : $(argument) ] ;

      requirements += <define>$(value) ;
    }
    else if [ MATCH ^[-/]I(.*) : $(argument) ] {
      local value = [ MATCH ^[-/]I(.*) : $(argument) ] ;

      requirements += <include>$(value) ;
    }
    else {
      requirements += <cxxflags>$(argument) ;
    }
  }

  return $(requirements) ;
}

# Helper rule for extracting compiler/linker options from strings (unix oriented)
local rule libraries-from-string ( name : ldflags + : requirements * : default * : usage-requirements * ) {
  local library_search_paths ;
  local library_link_paths ;
  local library_names ;
  local framework_names ;

  requirements = [ property.change $(requirements) <link>$(WX_CONFIG) : <link> $(WX_CONFIG) ] ;

  for local part in $(ldflags) {
    if $(part) {
      if [ MATCH "^-?L(.*)$" : $(part) ] {
        local search_path = [ MATCH "-?L([^ ]+)[ ]*$" : $(part) ] ;

        library_search_paths += <search>$(search_path) ;
        library_link_paths += <link>shared:<dll-path>$(search_path) ;
      }
      else if [ MATCH "^-?l(.*)$" : $(part) ] {
        local library-name = [ MATCH "-?l([^ ]+)[ ]*$" : $(part) ] ;

        if ! $(library-name) in $(library-targets) {
          searched-lib $(library-name)
              :
              : <name>$(library-name) $(library_search_paths)
              :
              : <framework>$(framework_names)
                $(library_link_paths)
              ;

          library-targets += $(library-name) ;
        }

        library_names += $(library-name) ;
      }
      else if [ MATCH "^-?m(.*)$" : $(part) ] {
      }
      else if [ MATCH "^-?Wl(.*)$" : $(part) ] {
      }
      else if $(is-framework-name) { # OS X specific
        is-framework-name = ;

        framework_names += $(part) ;
      }
      else if $(part) = -framework { # OS X specific
        is-framework-name = true ;
      }
      else if [ modules.peek : NT ] { # MSVC specific
        if [ MATCH "^/LIBPATH:(.*)$" : $(part) ] {
          local search_path = [ MATCH "/LIBPATH:(.*)$" : $(part) ] ;

          library_search_paths += <search>$(search_path) ;
        }
        else if ! [ MATCH "-.*" : $(part) ] {
          searched-lib $(name)$(part)
              :
              : <name>$(part) $(library_search_paths)
              :
              : $(library_link_paths)
              ;

          library_names += $(name)$(part) ;
        }
      }
    }
  }

  alias $(name) : $(library_names) : $(requirements) : $(default) : $(usage-requirements) ;
}

# OpenGL configuration
searched-lib GLU : : <target-os>windows <name>glu32 ;
searched-lib GLU : : <target-os>cygwin <name>glu32 ;
searched-lib GLU : : <target-os>solaris <name>GLU ;

searched-lib GL : : <name>GL <link>shared ;

alias opengl : GL
             : <target-os>solaris:<source>GLU
               <search>"$(OPENGL_LPATH)" : : <include>"$(OPENGL_IPATH)" ;
searched-lib opengl   : GLU
             : <target-os>windows
               <name>"opengl32"
               <search>"$(OPENGL_LPATH)" : : <include>"$(OPENGL_IPATH)" ;
searched-lib opengl   : GLU
             : <target-os>cygwin
               <name>"opengl32"
               <search>"$(OPENGL_LPATH)" : : <include>"$(OPENGL_IPATH)" ;
alias opengl : : <target-os>darwin : : <framework>OpenGL ;

if ! $(BOOST_LIBRARY_PATH) {
  use-project /boost : ../3rd-party/boost ;
}

local boost-requirements =
               <include>$(BOOST_ROOT)
               <define>BOOST_ALL_NO_LIB=1 # no autolinking
               <define>BOOST_MPL_CFG_NO_PREPROCESSED_HEADERS=1
               <define>BOOST_MULTI_INDEX_DISABLE_SERIALIZATION=1
               <target-os>windows:<define>WIN32_LEAN_AND_MEAN=1
               <target-os>windows:<define>_WIN32_WINNT=0x0501 ;

cpp-pch boost.pch
            : precompile/boost.hpp
            : $(boost-requirements)
              <link>shared:<define>BOOST_SYSTEM_DYN_LINK=1
              <link>shared:<define>BOOST_FILESYSTEM_DYN_LINK=1
              <link>shared:<define>BOOST_THREAD_USE_DLL=1
              <link>static:<define>BOOST_SYSTEM_STATIC_LINK=1
              <link>static:<define>BOOST_FILESYSTEM_STATIC_LINK=1
              <link>static:<define>BOOST_THREAD_USE_LIB=1
              <define>BOOST_THREAD_POSIX
              $(boost-requirements)
            :
            : $(boost-requirements)
              <link>shared:<define>BOOST_SYSTEM_DYN_LINK=1
              <link>shared:<define>BOOST_FILESYSTEM_DYN_LINK=1
              <link>shared:<define>BOOST_THREAD_USE_DLL=1
              <link>static:<define>BOOST_SYSTEM_STATIC_LINK=1
              <link>static:<define>BOOST_FILESYSTEM_STATIC_LINK=1
              <link>static:<define>BOOST_THREAD_USE_LIB=1
              <define>BOOST_THREAD_POSIX
              <library>boost_system
            ;

rule use-precompiled-headers ( properties * ) {
  local targets ;

  if <pch>on in $(properties) {
    targets = <source>boost.pch ;
  }

  return $(targets) ;
}

alias boost : : : :
              $(boost-requirements)
              <conditional>@use-precompiled-headers
              <toolset>msvc:<cxxflags>/FIboost.hpp
              <target-os>windows,<toolset>intel:<cxxflags>/FIboost.hpp ;

local rule boost-library ( name link ? : requirements * : usage-requirements * : use-local-boost ? ) {
  rule find-target ( target ) {
    if $(link) {
      return $(target)/$(link) ;
    }
    else {
      return $(target) ;
    }
  }

  if $(use-local-boost) {
    alias boost_$(name) : [ find-target ../3rd-party/boost/libs/$(name)/build//boost_$(name) ]
                        : $(requirements) <threading>multi : : $(requirements) $(usage-requirements) ;
  }
  else if $(BOOST_INCLUDE_PATH) {
    searched-lib boost_$(name)
           :
           : <library-path>"$(BOOST_LIBRARY_PATH)"
             <name>"boost_$(name)-mt"
             <search>"$(BOOST_LIBRARY_PATH)"
           :
           : $(usage-requirements)
           ;
  }
  else {
    alias boost_$(name) : [ find-target /boost//$(name) ] : $(requirements) <threading>multi : : $(usage-requirements) ;
  }
}

boost-library filesystem : <use>boost ;
boost-library program_options : <use>boost ;
boost-library thread : <use>boost ;
boost-library signals <link>static : <use>boost ;
boost-library test : <toolset>msvc:<asynch-exceptions>on : <use>boost ;
boost-library system : ;

if $(DL) {
  searched-lib dl : : <name>"dl" <os>LINUX:<link>shared <os>CYGWIN:<link>static <os>SOLARIS:<link>shared ;
}
else {
  alias dl : : : : <define>NO_DYNLOAD ;
}

searched-lib   m  : : <name>"m" ;
alias m  : : <target-os>windows ;
searched-lib   z  : : <name>"z" ;

alias dynamic_loading : : <target-os>windows <define>NO_DYNLOAD : : <define>NO_DYNLOAD ;
alias dynamic_loading : : <target-os>freebsd ;
alias dynamic_loading : dl ;

# Socket library on SunOS/Solaris system
searched-lib nsl : : <name>nsl ;
searched-lib ws2 : : <name>"ws2_32" ;

alias socket ;
searched-lib   socket : : <target-os>solaris <name>socket : : <library>nsl ;
searched-lib   socket :
             : <target-os>windows
               <name>wsock32
             :
             : <define>__USE_W32_SOCKETS
               <define>_WIN32_WINNT=0x0501
               <library>ws2
             ;

searched-lib   socket :
             : <target-os>cygwin
               <name>wsock32
             :
             : <define>__USE_W32_SOCKETS
               <define>_WIN32_WINNT=0x0501
               <library>ws2
             ;

if $(CADP_HEADERS) {
  searched-lib bcg : : <name>BCG <search>"$(CADP_LIBRARIES)" ;
  searched-lib bcg_io : : <name>BCG_IO <search>"$(CADP_LIBRARIES)" ;

  alias BCG : bcg bcg_io : : : <include>"$(CADP_HEADERS)" <define>USE_BCG ;
}
else {
  alias BCG : : : : ;
}

if $(USE_CVC) {
  searched-lib gmp : : <name>gmp ;

  searched-lib cvc
      : gmp
      : <name>cvc3
        <search>"$(USE_CVC)/lib"
      :
      : <define>HAVE_CVC
#        <define>HAVE___GNU_CXX__EXT_HASH_MAP
#        <define>HAVE___GNU_CXX__EXT_HASH_SET
        <include>$(USE_CVC)/include/cvc3
      ;
}
else {
  alias cvc ;
}

if $(WX_CPPFLAGS) {
  local wx-requirements = [ requirements-from-string $(WX_CPPFLAGS) ]
           <user-interface>gui
           <toolset>gcc,<target-os>windows:<linkflags>-mwindows ;
#                           <stdlib>stlport:<define>HAVE_STD_UNORDERED_MAP
#                           <stdlib>stlport:<define>HAVE_STD_UNORDERED_SET ;

  cpp-pch wx.pch
           : precompile/wx.hpp
           : $(wx-requirements)
            <use>boost.pch
           :
           : <define>BOOST_THREAD_POSIX
             <toolset>msvc:<cxxflags>/FIwx.hpp
             <use>boost.pch
             <target-os>windows,<include>intel:<cxxflags>/FIwx.hpp
           ;

  libraries-from-string wx_base
          : $(WX_BASE_LDFLAGS)
          :
          :
          : $(wx-requirements)
          ;

  libraries-from-string wx_gl
          : $(WX_GL_LDFLAGS)
          :
          :
          : $(wx-requirements)
          ;
}

